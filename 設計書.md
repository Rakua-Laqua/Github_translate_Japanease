
---

# GitHub 日本語化拡張 設計書 v1.0

## 1. 目的

* `github.com` の **UIラベル**（ナビ、ボタン、メニュー、フォーム補助テキスト等）を、**英→日**の辞書置換で日本語化する。
* GitHub特有の **部分更新（SPA/動的DOM差し替え）**に追従し、ページ移動やロード後に表示されるUIも翻訳する。
* 辞書にない英語UI文字列を **自動で収集**し、辞書拡充を継続的に容易にする。

## 2. スコープ

### 対象（翻訳する）

* GitHub UIの定型テキスト

  * 例：タブ名、ボタン、メニュー、ダイアログの見出し、設定画面の項目名、検索欄のplaceholder、`aria-label`/`title` 等の補助ラベル

### 非対象（翻訳しない）

* ユーザー生成コンテンツ（事故防止）

  * README/Issue/PR本文、コメント、コードブロック、コミットメッセージ、差分表示 など
* `pre`, `code`, `textarea`, `input` の内部テキスト（原則）
* Markdown本文領域（例：`.markdown-body`）は基本スキップ（設定で変更可能）

## 3. 方式の概要

* **辞書置換方式（完全一致を基本）**

  * 画面上の文字列が辞書キーに一致すれば、日本語に差し替える
* **動的追従**

  * DOM変化監視（追加/差し替え）を検知して部分翻訳
  * URL変更（pushState遷移）を検知して再スキャン
* **辞書外の文字列の収集**

  * 「翻訳対象っぽいのに辞書にない」テキストを検出し、ローカルにログ保存
  * ログは重複排除・容量制限・対象領域スキップで安全運用

---

# 4. 主要要件

## 4.1 機能要件

1. **日本語化ON/OFF**

   * 拡張ポップアップで切り替え
2. **対象ページ**

   * `https://github.com/*`
3. **翻訳対象の種類**

   * TextNode（画面表示文字）
   * 属性：`aria-label`, `title`, `placeholder`（必要に応じて追加）
4. **辞書の外部化**

   * 拡張機能に同梱する静的辞書ファイル（例：`dictionary.json`）
   * ユーザー追加辞書（ローカル保存）で上書き・追記できる
5. **辞書の自動収集ログ**

   * 辞書未登録の候補文字列を収集・保存
   * ログの閲覧・コピー/エクスポート機能
6. **動的更新追従**

   * DOM監視により追加表示されたUIも翻訳
7. **除外制御**

   * 除外セレクタ（例：`pre, code, .markdown-body`等）
   * ユーザー設定で調整可能（上級者向け）

## 4.2 非機能要件

* **パフォーマンス**：ページ操作を重くしない（監視は最小限、差分処理、重複処理抑制）
* **安全性**：ユーザー生成コンテンツを翻訳しない（誤翻訳事故・情報漏えいのリスク低減）
* **保守性**：辞書更新が容易（辞書外ログ → 辞書追加の運用が回る）
* **互換性**：Chrome/Edge（MV3）。将来的にFirefox対応の余地は残す

---

# 5. 全体アーキテクチャ

## 5.1 構成要素

1. **Content Script（翻訳エンジン）**

   * DOM走査
   * 置換
   * DOM変化監視
   * 辞書外ログ収集
2. **Service Worker（背景処理）**

   * 基本は不要（MV3要件で最小限）
   * ただし「ログのエクスポート」等で必要なら補助的に利用
3. **Popup UI（ON/OFF・簡易操作）**

   * 有効/無効
   * ログ収集の有効/無効
   * 「ログをコピー」「ログを消去」などの導線
4. **Options Page（詳細設定）**

   * 除外セレクタ設定
   * ユーザー辞書の編集（追記・上書き）
   * 自動収集ログの閲覧、エクスポート（JSON/CSV）
   * ログ最大件数、収集対象の粒度設定

## 5.2 データ保存先

* `chrome.storage.sync`（PC間同期したい設定）

  * enabled（ON/OFF）
  * excludeSelectors（除外設定）
  * loggingEnabled（収集ログON/OFF）
  * userDictionary（ユーザー追加辞書）
* `chrome.storage.local`（容量・ログ向け）

  * unknownLog（辞書外収集ログ本体）
  * unknownLogIndex（重複排除用のハッシュ/キー集合）

---

# 6. 辞書設計（外部化）

## 6.1 辞書ファイル（同梱辞書）

* ファイル例：`dictionary.json`
* 形式は「英語キー → 日本語値」のマップ（基本）
* 将来拡張（表記揺れ、複数候補、文脈別）を見据えて、v1では以下の運用方針：

  * **まず完全一致が最優先**
  * 必要になったら「正規化したキー」や「別名」を追加する

### 辞書の優先順位

1. ユーザー辞書（ユーザーが追加/修正したもの）
2. 同梱辞書（拡張機能が提供する基本辞書）

## 6.2 正規化ルール（設計）

完全一致だけだと拾えない表記揺れが出るため、検索前に「正規化」を行う（段階導入）。

* 前後の空白トリム
* 連続空白の1個化
* `…`/`...` など記号揺れの統一（必要になったら）
* 大文字小文字の統一（必要になったら。ただし意味が変わるケースは注意）

> v1では「トリム＋連続空白の圧縮」までを基本とし、過剰な正規化はしない（誤置換を避ける）。

---

# 7. 翻訳エンジン設計

## 7.1 翻訳対象の抽出

### 対象ノード

* TextNode（表示テキスト）
* 属性（補助ラベル）

  * `aria-label`
  * `title`
  * `placeholder`

### 除外

* 親要素が除外セレクタに該当するものは翻訳しない
  例（初期値案）：

  * `pre, code, textarea, input, .markdown-body`

## 7.2 置換ポリシー

* **完全一致**（正規化後の一致）でのみ置換
* 置換後に二重置換されないよう「同じテキストは再翻訳しない」工夫を入れる

  * 例：置換済みマーク（WeakMap/属性付与など。実装詳細は後で決める）

## 7.3 動的更新の追従

* DOM監視で「追加されたノード」だけを対象に翻訳する
* URL変化検知（pushState遷移）でページ全体の翻訳を再実行
* 過剰実行を避けるための抑制策

  * 監視イベントは短時間でまとめて処理（デバウンス）
  * 追加ノードが巨大な場合は部分走査で止める（上限）

---

# 8. 辞書外 自動収集ログ設計

## 8.1 収集の目的

* 「辞書に無いが、UIとして頻出する英語」を集めて辞書拡充を容易にする

## 8.2 収集対象の条件（安全運用）

* 除外セレクタ配下は収集しない（ユーザー生成コンテンツが入りやすい）
* 収集は **“UIっぽい短文”**に限定（例）

  * 文字数：2〜80程度
  * 改行を含む長文は除外
  * URLっぽい/コードっぽいものは除外
* 同一文字列は重複収集しない（キー化してデデュープ）
* ログ容量上限（例：最大 2000 件、または 1MB相当）を超えたら古いものから削除

## 8.3 ログの保存形式（概念スキーマ）

ログ1件に含める情報（例）：

| フィールド         | 内容                                                  |
| ------------- | --------------------------------------------------- |
| `text`        | 収集した英語文字列（正規化前/後どちらかは方針で統一）                         |
| `type`        | `textNode` / `aria-label` / `title` / `placeholder` |
| `url`         | 発見時のURL（パスまで。クエリは必要なら削る）                            |
| `firstSeenAt` | 初回観測時刻                                              |
| `lastSeenAt`  | 最終観測時刻                                              |
| `count`       | 観測回数（頻出度）                                           |
| `hint`        | 位置情報ヒント（例：親要素のtag/classの簡易情報 ※個人情報にならない範囲）          |

> 重要：DOMの全文や周辺テキストを丸ごと持たない。**最小限のメタ情報のみ**にする。

## 8.4 ログのUX

* Popup

  * ログ収集 ON/OFF
  * 「未知語ログをコピー（JSON/CSV）」
  * 「ログを全消去」
* Options

  * ログ一覧（頻出順・新着順ソート）
  * フィルタ（URL別、属性別）
  * エクスポート（JSON/CSV）
  * エクスポート時に「辞書テンプレ形式」を生成できると便利

    * 例：`"New issue": ""` のように空欄訳を作る（ただしここでは設計のみ）

---

# 9. 設定項目

## 9.1 基本設定

* 日本語化：ON/OFF（デフォルトON）
* ログ収集：ON/OFF（デフォルトON）
* 翻訳対象属性：ON/OFF（aria-label/title/placeholder）

## 9.2 上級設定（Options）

* 除外セレクタ（初期値あり）
* ログ最大件数
* 収集文字数範囲
* 正規化強度（v1は固定でもOK。将来拡張）

---

# 10. 例外・エラーハンドリング

* 辞書読み込み失敗時

  * 翻訳は停止し、ログに「辞書ロード失敗」を記録（開発者向け）
* storageアクセス失敗時

  * 設定はデフォルトで動作
  * ログ収集だけ無効化（安全側）

---

# 11. セキュリティ・プライバシー配慮

* 外部通信なし（翻訳APIを使わない）
* 収集ログはローカル保存のみ（エクスポートはユーザー操作）
* ユーザー生成コンテンツ領域は翻訳・収集ともに除外が基本
* クリップボードコピーはユーザー操作でのみ実行

---

# 12. テスト方針

## 12.1 動作確認ページ

* リポジトリトップ（Code/Issues/PR/Actions）
* Issue一覧 / Issue詳細
* PR一覧 / PR詳細
* Settings（リポジトリ設定、プロフィール設定）
* 検索結果ページ
* 通知ページ

## 12.2 観点

* 初回ロード時に主要UIが翻訳される
* SPA遷移後も翻訳が維持される（戻る/進む含む）
* README/コメントなどが翻訳されない
* ログが重複せず、頻出カウントが増える
* パフォーマンス劣化がない（スクロール、入力、タブ切替）

---

# 13. リリース・運用

* v0.1：MVP（完全一致辞書＋動的追従＋未知語ログ収集＋エクスポート）
* v0.2：辞書正規化の強化、除外セレクタのチューニング
* v1.0：オプション画面の充実、辞書更新運用（テンプレ生成、差分取り込み）

---

## 付録：推奨ファイル構成（例）

* `manifest.json`
* `content/translator`（翻訳エンジン）
* `data/dictionary.json`（同梱辞書）
* `ui/popup`（ポップアップ）
* `ui/options`（詳細設定）
* `storage`（設定/ログ永続化）

---